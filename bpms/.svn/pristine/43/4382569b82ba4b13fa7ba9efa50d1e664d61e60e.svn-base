<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="kr.or.ddit.projects.kanban.dao.KanbanDAO">
	
	<resultMap type="kr.or.ddit.projects.kanban.vo.KanbanVO" id="kanbanMap" autoMapping="true">
		<id property="kboardId" column="KBOARD_ID"/>
		<collection property="stickerList" ofType="kr.or.ddit.projects.kanban.vo.KanbanStickerVO" autoMapping="true">
			<id property="kstickerId" column="KSTICKER_ID"/>
		</collection>
	</resultMap>
	
	<select id="myKanbanList" parameterType="kr.or.ddit.projects.member.vo.MemberVO" resultMap="kanbanMap">

  	SELECT 
    A.MEM_ID MEM_ID
    ,A.MEM_IMG
    ,B.KBOARD_ID KBOARD_ID
    ,B.KBOARD_TITLE KBOARD_TITLE
    ,C.KSTICKER_ID KSTICKER_ID
    ,C.KSTICKER_TITLE
    ,C.KBOARD_ID
    ,C.KSTICKER_SORT
	,C.KSTICKER_CONTENT
	,TO_CHAR(C.CREATE_DATE, 'YYYY-MM-DD') CREATE_DATE
	  FROM MEMBER A
	  INNER JOIN KANBAN_BOARD B
	      ON A.MEM_ID = B.MEM_ID
	  LEFT OUTER JOIN KANBAN_STICKER C
	      ON B.KBOARD_ID = C.KBOARD_ID
	  WHERE A.MEM_ID = #{memId, jdbcType=VARCHAR}
	  ORDER BY B.KBOARD_ID, C.KSTICKER_SORT DESC
	  
	  	
	</select>
	
	<insert id="insertSticker" parameterType="kr.or.ddit.projects.kanban.vo.KanbanStickerVO">
	<selectKey order="BEFORE" keyProperty="kstickerId" resultType="string">
		SELECT CONCAT('KS',LPAD(TO_CHAR(TO_NUMBER(SUBSTR(NVL(MAX(KSTICKER_ID),CONCAT('KS',LPAD(0,10,0))),3))+1),10,0))
  	    FROM KANBAN_STICKER
  	</selectKey>
	INSERT INTO KANBAN_STICKER(
		KSTICKER_ID
		,KSTICKER_TITLE
		,KSTICKER_CONTENT
		,CREATE_DATE
		,KBOARD_ID
		,KSTICKER_SORT
	)
	VALUES(
		#{kstickerId, jdbcType=VARCHAR}
		,#{kstickerTitle, jdbcType=VARCHAR}
		,#{kstickerContent, jdbcType=CLOB}
		,SYSDATE
		,#{kboardId, jdbcType=VARCHAR}
		,#{kstickerSort, jdbcType=NUMERIC}
	)
	</insert>

	<select id="currentSticker" parameterType="kr.or.ddit.projects.kanban.vo.KanbanStickerVO" resultType="kr.or.ddit.projects.kanban.vo.KanbanStickerVO">
		SELECT 
		KSTICKER_TITLE
		,KSTICKER_SORT         
	    FROM KANBAN_STICKER
	   WHERE KSTICKER_ID = #{kstickerId, jdbcType=VARCHAR}
	</select>
	
	<select id="retrieveSticker" parameterType="kr.or.ddit.projects.kanban.vo.KanbanStickerVO" resultType="kr.or.ddit.projects.kanban.vo.KanbanStickerVO">
	SELECT
		KSTICKER_TITLE
		,KSTICKER_CONTENT
		,TO_CHAR(CREATE_DATE, 'YYYY-MM-DD') CREATE_DATE
		,TO_CHAR(MODIFY_DATE, 'YYYY-MM-DD') MODIFY_DATE
		,KSTICKER_SORT
	 FROM KANBAN_STICKER
    WHERE KSTICKER_ID = #{kstickerId, jdbcType=VARCHAR}
	</select>
</mapper>