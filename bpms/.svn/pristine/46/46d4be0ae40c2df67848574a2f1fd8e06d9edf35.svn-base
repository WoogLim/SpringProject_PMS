<%@ page language="java" contentType="text/html; charset=UTF-8"
    pageEncoding="UTF-8"%>
<%@ taglib uri="http://java.sun.com/jsp/jstl/core" prefix="c" %>
<%@ taglib prefix="security" uri="http://www.springframework.org/security/tags"%>
<%--
* [[개정이력(Modification Information)]]
* 수정일                          수정자        수정내용
* ----------------------------------------
* 2021. 2. 5.      이선엽       최초작성
* Copyright (c) 2021 by DDIT All right reserved
 --%>
<security:authorize access="isAuthenticated()">
	<security:authentication property="principal" var="principal" />
	<c:set var="authMember" value="${principal.realMember }" />
	<div class="panel-header">
		<div class="page-inner">
			<span class="project-path"> <a href="">게시판</a>/ <a href="">일일
					업무 보고</a>
			</span> <br>
			<div class="issue-header clearfix">
				<div class="float-left">
					<h1 class="fw-mediumbold" style="padding-left: 10px">
						${boardVO.boardTitle}</h1>
				</div>
				<button class="btn btn-success float-right d-flex" id="listBtn" onclick="location.href='${cPath }/workReport/workReportList.do?proId=${param.proId }'">
					<i class="fas fa-list">목록</i>
				</button>
			</div>
			<hr style="border-bottom: 2px solid black;">
			<div class="issue-body clearfix">
				<div class="float-left">
					<h4 class="fw-mediumbold" style="padding-left: 30px">${boardVO.boardWriter} ${boardVO.createDate }</h4>
				</div>
				<br>
				<hr style="border-bottom: 1px solid black;">
				<div class="float-left">
					<c:if test="${not empty boardVO.attatchList }">
						<c:forEach items="${boardVO.attatchList }" var="attatch"
							varStatus="vs">
							<c:url value="/board/download.do" var="downloadURL">
								<c:param name="attNo" value="${attatch.attNo }" />
							</c:url>
							<a href="${downloadURL }">
								<h5 style="padding-left: 30px; color: black">
									<i class="fas fa-file" style="margin-right: 12px"></i>${attatch.attOriginname }
								</h5>
								${not vs.last?"|":"" }
							</a>
						</c:forEach>
					</c:if>
					<c:if test="${empty boardVO.attatchList }">
						<h5 style="padding-left: 30px">첨부파일이 존재하지 않습니다.</h5>
					</c:if>
				</div>
				<br>
				<hr>
				<div class="float-left">
					<h4 style="padding-left: 30px">${boardVO.boardContent }</h4>
				</div>
			</div>
			<br>
			<hr>
			<c:if test = "${authMember.memName eq boardVO.boardWriter }">
				<div class="issue-footer clearfix">
					<div class="float-right">
						<c:url value="/workReport/workReportUpdate.do" var="updateURL">
							<c:param name="boardNo" value="${boardVO.boardNo }" />
							<c:param name="proId" value="${param.proId }" />
						</c:url>
							<a class="btn btn-primary" href="${updateURL }">수정</a> 
							<input type="button" value="삭제" class="btn btn-danger" id="removeBtn" />
					</div>
				</div>
			</c:if>
		</div>
	</div>


	<br>

	<div class="issue-body clearfix">
		<h3 style="padding-left: 30px;">댓글</h3>
		<hr style="border: 1px solid black">
		<form method="post" class="form-inline" id="replyInsertForm"
			action="${pageContext.request.contextPath }/reply/replyInsert.do">
			<input type="hidden" name="replyNo" /> <input type="hidden"
				name="boardNo" value="${boardVO.boardNo }" />
			<table class="col-md-10">
				<tr>
					<td><input type="text" class="form-control mb-2"
						name="replyWriter" value="${authMember.memName }" readonly
						maxlength="10" /></td>
				</tr>
				<tr>
					<td colspan="2">
						<div class="input-group">
							<textarea class="form-control mb-2 mr-2" rows="2"
								placeholder="내용 200자 이내" maxlength="200" name="replyContent"></textarea>
						</div>
					</td>
					<td colspan="3"><input type="submit" value="전송"
						class="btn btn-primary" /></td>
				</tr>
			</table>
		</form>
		<table id="replyTable" class="table table-bordered">
			<thead class="table">
				<tr>
					<th class="text-center" style="width: 20%">작성자</th>
					<th class="text-center" style="width: 60%">내용</th>
					<th class="text-center" style="width: 20%">작성일</th>
				</tr>
			</thead>
			<tbody id="listBody">

			</tbody>
		</table>
		<div id="pagingArea"></div>
	</div>
</security:authorize>
<div class="modal fade" id="replyModal" tabindex="-1" aria-labelledby="replyModalLabel" aria-hidden="true">
 <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="replyModalLabel">댓글 수정</h5>
      </div>
      <security:authorize access="isAuthenticated()">
		<security:authentication property="principal" var="principal" />
		<c:set var="authMember" value="${principal.realMember }" />
      <form action="${pageContext.request.contextPath }/reply/replyUpdate.do" method="post">
      	<input type="hidden" name="replyNo" required/>
      	<input type="hidden" name="boardNo"  required value="${boardVO.boardNo }"/>
	      <div class="modal-body">
	      	<table class="table form-inline">
	      		<tr>
	      			<td>
	      				<input type="text" required name="replyWriter" class="form-control" placeholder="작성자" value="${authMember.memName }" readonly/>
	      			</td>
	      		</tr>
	      		<tr>
	      			<td colspan="2">
						<div class="input-group">
							<textarea class="form-control mb-2 mr-2" rows="2" placeholder="내용 200자 이내"maxlength="200" name="replyContent"></textarea>
						</div>
					</td>
	      		</tr>
	      	</table>
	      </div>
	      <div class="modal-footer">
	        <button type="submit" class="btn btn-success">수정</button>
	        <button type="button" class="btn btn-danger" data-dismiss="modal">닫기</button>
	      </div>
      </form>
      </security:authorize>
    </div>
  </div>
</div>
<div class="modal fade" id="replyChildModal" tabindex="-1" aria-labelledby="replyChildModalLabel" aria-hidden="true">
 <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="replyChildModalLabel">대댓글</h5>
      </div>
      <security:authorize access="isAuthenticated()">
		<security:authentication property="principal" var="principal" />
		<c:set var="authMember" value="${principal.realMember }" />
      <form action="${pageContext.request.contextPath }/reply/replyInsert.do" method="post">
      	<input type="hidden" name="replyParent" required/>
      	<input type="hidden" name="boardNo"  required value="${boardVO.boardNo }"/>
	      <div class="modal-body">
	      	<table class="table form-inline">
	      		<tr>
	      			<td>
	      				<input type="text" required name="replyWriter" class="form-control" value="${authMember.memName }" readonly/>
	      			</td>
	      		</tr>
	      		<tr>
	      			<td colspan="2">
						<div class="input-group">
							<textarea id="inputContent"class="form-control mb-2 mr-2" rows="2" placeholder="내용 200자 이내" maxlength="200" name="replyContent"></textarea>
						</div>
					</td>
	      		</tr>
	      	</table>
	      </div>
	      <div class="modal-footer">
	        <button type="submit" class="btn btn-success">등록</button>
	        <button type="button" class="btn btn-danger" data-dismiss="modal">닫기</button>
	      </div>
      </form>
      </security:authorize>
    </div>
  </div>
</div>

<form id="deleteForm" method="post" action="${cPath }/workReport/workReportDelete.do?proId=${param.proId}">
	<input type="hidden" name="boardNo" value="${boardVO.boardNo }" />
</form>
<form id="searchForm" action="${pageContext.request.contextPath }/reply/replyList.do" method="get">
	<input type="hidden" name="boardNo" value="${boardVO.boardNo }" />
	<input type="hidden" name="page" />
</form>
<form id="replyDeleteForm" action="${pageContext.request.contextPath }/reply/replyDelete.do" method="post">
	<input type="hidden" name="replyNo"/>
   	<input type="hidden" name="boardNo"  required value="${boardVO.boardNo }"/>
</form>	
<script>
	let deleteForm = $("#deleteForm");
	let removeBtn = $("#removeBtn").on("click", function(){
		deleteForm.submit();
	});
	let inputContent = $("inputContent");
	function commonSuccess(resp){
		if(resp.result == "OK"){
			replyInsertForm.get(0).reset();
			inputContent.text("");
			replyModal.modal("hide");
			replyChildModal.modal("hide");
			searchForm.submit();
		}else if(resp.message){
			alert(resp.message);
		}
	}
	// 대댓글
	function childReply(event){
		let reply = $(this).parents("tr:first").data("reply");
		let replyParent = reply.replyNo;
		replyChildForm.get(0).replyParent.value = replyParent;
		replyChildModal.modal("show");
	}
	// 수정
	function updateReply(event){
		let reply = $(this).parents("tr:first").data("reply");
// 		for(let prop in reply){
// 			$(replyUpdateForm).find("[name='"+prop+"']").val(reply[prop]);
// 		}
		replyModal.modal("show");
	}
	// 삭제
	function deleteReply(event){
		let reply = $(this).parents("tr:first").data("reply");
		for(let prop in reply){
			$(replyUpdateForm).find("[name='"+prop+"']").val(reply[prop]);
		}
		$(replyDeleteForm).find("[name='replyNo']").val(reply.replyNo);
		$(replyDeleteForm).submit();
	}
	
	let listTable = $("#replyTable").on("click", ".replyBtn", childReply)
	 								.on("click", ".updateBtn", updateReply)
									.on("click", ".delBtn", deleteReply)
									.find("#listBody");
	
	let replyModal = $("#replyModal").on("hidden.bs.modal", function(){
		$(this).find("form").get(0).reset();
	});
	let replyChildModal = $("#replyChildModal").on("hidden.bs.modal", function(){
		$(this).find("form").get(0).reset();
	});
	
	let options ={
		dataType : "json",
		success :commonSuccess
	}
	
	let replyInsertForm = $("#replyInsertForm").ajaxForm(options);
	let replyUpdateForm = replyModal.find("form").ajaxForm(options);
	let replyChildForm = replyChildModal.find("form").ajaxForm(options);
	let replyDeleteForm = $("#replyDeleteForm").ajaxForm(options);
//========================================================	
	
//====================덧글 페이징=======================
	let pagingArea = $("#pagingArea");
	let pagingA = pagingArea.on('click', "a" ,function(){
		let page = $(this).data("page");
		searchForm.find("[name='page']").val(page);
		searchForm.submit();
		searchForm.find("[name='page']").val(1);
		return false;
	});
	
	let searchForm = $("#searchForm").ajaxForm({
		dataType : "json",
		success : function(resp) {
			listTable.find("tbody").empty();
			pagingArea.empty();
			let replyList = resp.dataList;
			let trTags = [];
			if(replyList){
				$(replyList).each(function(idx, reply){
					let tr = $("<tr>");
					tr.append($("<td>").text(reply.replyWriter)
							.addClass("text-center writerClass"),
							$("<td>").html(reply.replyContent)
									.addClass("text-left"),
							$("<td>").text(reply.createDate)
									.addClass("text-center"));
					if(reply.replyWriter === "${authMember.memName}"){
						tr.append(
								$("<td>").append(
									$("<input>").attr({
										type:"button",
										value:"덧글"
									}).addClass("btn btn-primary mr-2 replyBtn"),
									$("<input>").attr({
										type:"button",
										value:"수정"
									}).addClass("btn btn-info mr-2 updateBtn"),		
									$("<input>").attr({
										type:"button",
										value:"삭제"
									}).addClass("btn btn-danger mr-2 delBtn")		
								).addClass("text-center")	
						).data("reply", reply);
					}else{
						tr.append(
								$("<td>").append(
									$("<input>").attr({
										type:"button",
										value:"덧글"
									}).addClass("btn btn-primary mr-2 replyBtn")
								).addClass("text-center")	
						).data("reply", reply);
					}
					
					trTags.push(tr);
				});
			}else{
				trTags.push(
					$("<tr>").html(
						$("<td>").text("댓글이 없음.")									
					)
				);
			}
			listTable.html(trTags);
			if(replyList.length>0)
				pagingArea.html(resp.pagingHTML);
		},
		error : function(errResp) {
			console.log(errResp);
		}
	}).submit();
</script>