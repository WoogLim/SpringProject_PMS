<%@ page language="java" contentType="text/html; charset=UTF-8"
    pageEncoding="UTF-8"%>
<%@ taglib uri="http://java.sun.com/jsp/jstl/core" prefix="c" %>
<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<style>
	body {
	font-family: sans-serif;
	background: #ccc;
	}
	.ganttTable{
		float: left;
		width: 180px;
		text-align: center;
		border-right: solid 1px;
		border-right-color: #A4A4A4;
	}
	.divBody{
		height: auto;
		border-bottom: solid 1px;
		border-color: #ebeff2;
		height: 38px;
		font-size: 12px;
		text-align: left;
		font-weight: bolder;
/* 		border-right: solid 1px; */
/* 		border-right-color: #A4A4A4; */
	}
	.divBody:nth-child(odd){
		background-color: #f5f5f5;
	}
	.divHead{
		height: 60px;
		background-color: #FBEFF2;
		border-top: solid 1px;
 		border-bottom: solid 2px;
 		border-color: #e0e0e0;
 		
	}
	/* custom class */
	.gantt .bar-milestone .bar {
		fill: tomato;
	}
	
	#spanType{
		color: #FF0040;
		font-style: oblique;
		
	}
	
	.selectOptions{
		background-color: #2E64FE;
	}

</style>
<jsp:include page="/includee/preScript.jsp"></jsp:include>
</head>
<body>
<c:set var="wrCustomList" value="${wrCustomList }"/>
<c:set var="wtCustomList" value="${wtCustomList }"/>
<c:set var="wsCustomList" value="${wsCustomList }"/>
<c:set var="scheduleList" value="${scheduleVO.scheduleList }" />
<c:set var="ganttVO" value="${ganttVO }" />
<div class="panel-header">
	<div class="page-inner">
		<span class="project-path">
			<a href="">프로젝트</a>
			<a href="">PMS 프로그램 개발</a>
		</span>
   
		<div class="issue-header clearfix">
			<div class="float-left">
				<h1 class="fw-mediumbold"> 간트차트</h1>
			</div>
	
<!-- 			<button type="button" class="btn btn-primary dropdown-toggle float-right d-flex" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false"> -->
<!-- 				Sort By Date -->
<!-- 			</button> -->
<!-- 			<div class="dropdown-menu"> -->
<!-- 				<span class="dropdown-item">Month</span> -->
<!-- 				<span class="dropdown-item">Week</span> -->
<!-- 				<span class="dropdown-item">Day</span> -->
<!-- 			</div> -->
		</div>
		<div class="filter__card">
			<ul class="filter__role row">
				<h2 class="filter-title">검색 조건</h2>
				<div class="filter-init">
					<button id="initSearchOptions" type="button">검색 필터 초기화</button>
				</div>
				<li class="project-rules col-12 row">
					<!-- 우선순위(RANK) 구분 -->
					<div class="filter__condition col-2">
						<span class="condition__title">우선순위 : </span>
						<div class="filter__member-status selectbox">
							<label></label>
							<select id="rankOptions" data-optioncode="WR">
								<c:choose>
									<c:when test="${not empty ganttVO.workRank }">
										<option class="selectOptions" value="" class="selectOptions">${ganttVO.workRank }</option>
										<option value="">상관없음</option>
									</c:when>
									<c:otherwise>
										<option value="">상관없음</option>
									</c:otherwise>
								</c:choose>
								<c:if test="${not empty wrCustomList }">
									<c:forEach items="${wrCustomList }" var="wrCustomList">
										<c:set value="${wrCustomList.text}" var="selected"/>
										<option value="${wrCustomList.text }">${wrCustomList.text }</option>
									</c:forEach>
								</c:if>
							</select>
						</div>
					</div>
		
					<!-- 유형(TYPE) 구분 -->
					<div class="filter__condition col-2">
						<span class="condition__title">유형 : </span>
						<div class="filter__member-status selectbox">
							<label></label>
							<select id="typeOptions" data-optioncode="WT">
								<c:choose>
									<c:when test="${not empty ganttVO.workType }">
										<option class="selectOptions" value="">${ganttVO.workType }</option>
										<option value="">상관없음</option>
									</c:when>
									<c:otherwise>
										<option value="">상관없음</option>
									</c:otherwise>
								</c:choose>
								<c:if test="${not empty wtCustomList }">
									<c:forEach items="${wtCustomList }" var="wtCustomList">
										<c:set value="${wtCustomList.text ? 'selected' : ''}" var="selected"/>
										<option value="${wtCustomList.text }" ${selected }>${wtCustomList.text }</option>
									</c:forEach>
								</c:if>
							</select>
						</div>
					</div>
					
					<!-- 상태(STATE) 구분 -->
					<div class="filter__condition col-2">
						<span class="condition__title">상태 : </span>
						<div class="filter__member-status selectbox">
							<label></label>
							<select id="statusOptions" data-optioncode="WS">
								<c:choose>
									<c:when test="${not empty ganttVO.workState }">
										<option class="selectOptions" value="">${ganttVO.workState }</option>
										<option value="">상관없음</option>
									</c:when>
									<c:otherwise>
										<option value="">상관없음</option>
									</c:otherwise>
								</c:choose>
								<c:if test="${not empty wsCustomList }">
									<c:forEach items="${wsCustomList }" var="wsCustomList">
										<c:set value="${wsCustomList.text ? 'selected' : ''}" var="selected"/>
										<option value="${wsCustomList.text }" ${selected }>${wsCustomList.text }</option>
									</c:forEach>
								</c:if>
							</select>
						</div>
					</div>
					
					<!-- 날짜(Date) 구분 -->
					<div class="filter__condition col-2">
						<span class="condition__title">상태 : </span>
						<div class="filter__member-status selectbox">
							<label></label>
							<select id="dateOptions" data-optioncode="DO">
								<option>Month</option>
								<option>Week</option>
								<option>Day</option>
							</select>
						</div>
					</div>
				</li>
			</ul>
		</div>
		<div class="ganttTotal">
			<div class="ganttTable">
				<div class="divHead"></div>
				<c:forEach items="${scheduleList}" var="ganttTable">
					<div class="divBody"><span id="spanType">${ganttTable.workType}</span>&nbsp&nbsp<span id="spanTitle">${ganttTable.boardTitle}</span></div>
				</c:forEach>
			</div>
			<div class="gantt">
				<div class="gantt-target"></div>
			</div>
		</div>
	</div>
</div>

<form id="workListForm">
	<%-- 검색 조건 --%>
	<input type="hidden" name="workState" value="${ganttVO.workState }">
	<input type="hidden" name="workRank" value="${ganttVO.workRank }">	
	<input type="hidden" name="workType" value="${ganttVO.workType }">
	<input type="hidden" name="proId" value="${param.proId }">
</form>
<script type="text/javascript">
	$.fn.hasScrollBar = function() {
	    return (this.prop("scrollWidth") == 0 && this.prop("clientWidth") == 0) || (this.prop("scrollWidth") > this.prop("clientWidth"));
	};
	
	function wheel(name){
		$(name).on('mousewheel',function(e){
		    var hasScroll = $(this).hasScrollBar();
		    if(!hasScroll){
		    }else{
		        e.preventDefault(); 
		        var wheelDelta = e.originalEvent.wheelDelta;
		        if(wheelDelta > 0){
		            $(this).scrollLeft(-wheelDelta + $(this).scrollLeft());
		        }else{
		            $(this).scrollLeft(-wheelDelta + $(this).scrollLeft());
		        }
		    }
		});
	}
	$(function(){
	    wheel('.gantt-container');
	});
	
	let workListForm = $("#workListForm");
    let selectTarget = $('.selectbox select');

    selectTarget.each(function(){
    	let select_name = $(this).children('option:selected').text();
    	$(this).siblings('label').text(select_name)
    })
    
    selectTarget.change(function(){ 
        let select_name = $(this).children('option:selected').text(); 
        
        /* 형제 요소인 label에 표시 */
        $(this).siblings('label').text(select_name); 
    }); 
    
    // 검색조건 이벤트 처리
    $("div.filter__card").find("select").on("change", function() {
		let groupCode = $(this).data("optioncode");
		let val = $(this).val();
		switch(groupCode){
		case "WR":
			workListForm.find("input[name='workRank']").val(val);
			break;
		case "WT":
			workListForm.find("input[name='workType']").val(val);
			break;
		case "WS":
			workListForm.find("input[name='workState']").val(val);
			break;
		case "DIRECTOR":
			workListForm.find("input[name='workDirector']").val(val);
			break;
		case "DO":
			gantt_chart.change_view_mode(val);
			console.log(val);
			return;
		default:
			console.log("invalide args");
		}
		workListForm.submit();
    });
    
    // 검색조건 초기화
    $("#initSearchOptions").on("click", function() {
		let selects = $("div.filter__card").find("select");
		$(selects).each(function(idx, element) {
			$(this).val("");
		});
		
		let hiddens = workListForm.find("input");
		$(hiddens).each(function(idx, element){
			$(this).val("");
		});
		workListForm.submit();
    });

	let arr = new Array();
	<c:forEach items="${scheduleList}" var="gantt">
		arr.push({start: "${gantt.startDate }",
				  end: "${gantt.endDate }",
				  name: "${gantt.boardTitle }",
				  id: "${gantt.workId }",
				  progress: "${gantt.progress }",
				  dependencies: "${gantt.workParent }"});
	</c:forEach>
	
	let gantt_chart = new Gantt(".gantt-target", arr, {
		view_mode: 'Month',
		language: 'ko'
	});
</script>
</body>
</html>